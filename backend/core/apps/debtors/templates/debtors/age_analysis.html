{% extends 'base.html' %}

{% block title %}Age Analysis - Debtors System{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'debtors:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item">Enquiries</li>
        <li class="breadcrumb-item active">Age Analysis</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-chart-pie"></i> Age Analysis</h1>
    <p class="text-muted">Total Debtors Summary</p>
</div>

<!-- Filter Options -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-filter"></i> Report Options
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Analysis Type</label>
                <select class="form-select" name="analysis_type">
                    <option value="monthly" {% if request.GET.analysis_type == 'monthly' %}selected{% endif %}>
                        Monthly Age Analysis
                    </option>
                    <option value="weekly" {% if request.GET.analysis_type == 'weekly' %}selected{% endif %}>
                        Weekly Age Analysis
                    </option>
                </select>
            </div>

            {% if request.GET.analysis_type == 'weekly' %}
            <div class="col-md-3">
                <label class="form-label">Report Date</label>
                <input type="date" class="form-control" name="report_date" 
                       value="{{ request.GET.report_date|default:today }}">
            </div>
            {% endif %}

            <div class="col-md-3">
                <label class="form-label">Sequence</label>
                <select class="form-select" name="sequence">
                    <option value="A" {% if request.GET.sequence == 'A' %}selected{% endif %}>
                        Alphabetical
                    </option>
                    <option value="N" {% if request.GET.sequence == 'N' %}selected{% endif %}>
                        Numerical
                    </option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Area/Salesman</label>
                <select class="form-select" name="area">
                    <option value="">All Areas</option>
                    {% for area in sales_areas %}
                    <option value="{{ area.id }}" {% if request.GET.area == area.id|stringformat:"s" %}selected{% endif %}>
                        {{ area.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" name="show_zero" 
                           {% if request.GET.show_zero %}checked{% endif %}>
                    <label class="form-check-label">
                        Include Zero Balances
                    </label>
                </div>
            </div>

            <div class="col-md-9">
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sync"></i> Refresh Analysis
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Summary Totals -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-calculator"></i> Summary Totals
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Current</th>
                                <th>30 Days</th>
                                <th>60 Days</th>
                                <th>90 Days</th>
                                <th>120 Days</th>
                                <th>150 Days</th>
                                <th>180+ Days</th>
                                <th class="table-primary"><strong>Total</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>R {{ totals.current|default:0|floatformat:2 }}</strong></td>
                                <td><strong>R {{ totals.days_30|default:0|floatformat:2 }}</strong></td>
                                <td><strong>R {{ totals.days_60|default:0|floatformat:2 }}</strong></td>
                                <td><strong>R {{ totals.days_90|default:0|floatformat:2 }}</strong></td>
                                <td><strong>R {{ totals.days_120|default:0|floatformat:2 }}</strong></td>
                                <td><strong>R {{ totals.days_150|default:0|floatformat:2 }}</strong></td>
                                <td><strong>R {{ totals.days_180|default:0|floatformat:2 }}</strong></td>
                                <td class="table-primary"><strong>R {{ totals.total|default:0|floatformat:2 }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-table"></i> Detailed Age Analysis</span>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Print
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-sm" id="ageAnalysisTable">
                <thead class="table-light">
                    <tr>
                        <th>Acc #</th>
                        <th>Account Name</th>
                        <th>Contact</th>
                        <th class="text-end">Current</th>
                        <th class="text-end">30 Days</th>
                        <th class="text-end">60 Days</th>
                        <th class="text-end">90 Days</th>
                        <th class="text-end">120 Days</th>
                        <th class="text-end">150 Days</th>
                        <th class="text-end">180+ Days</th>
                        <th class="text-end"><strong>Total Due</strong></th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts %}
                    <tr>
                        <td>{{ account.account_number }}</td>
                        <td>
                            <a href="{% url 'debtors:account_detail' account.id %}">
                                {{ account.name }}
                            </a>
                        </td>
                        <td>
                            <small>{{ account.contact_person }}<br>{{ account.tel_1 }}</small>
                        </td>
                        <td class="text-end">{{ account.current|floatformat:2 }}</td>
                        <td class="text-end">{{ account.days_30|floatformat:2 }}</td>
                        <td class="text-end">{{ account.days_60|floatformat:2 }}</td>
                        <td class="text-end">{{ account.days_90|floatformat:2 }}</td>
                        <td class="text-end">{{ account.days_120|floatformat:2 }}</td>
                        <td class="text-end">{{ account.days_150|floatformat:2 }}</td>
                        <td class="text-end">{{ account.days_180|floatformat:2 }}</td>
                        <td class="text-end">
                            <strong>
                                {% if account.total_due > 0 %}
                                    <span class="text-danger">{{ account.total_due|floatformat:2 }}</span>
                                {% else %}
                                    {{ account.total_due|floatformat:2 }}
                                {% endif %}
                            </strong>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center text-muted py-4">
                            No accounts found matching criteria
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="3" class="text-end">TOTALS:</th>
                        <th class="text-end">R {{ totals.current|default:0|floatformat:2 }}</th>
                        <th class="text-end">R {{ totals.days_30|default:0|floatformat:2 }}</th>
                        <th class="text-end">R {{ totals.days_60|default:0|floatformat:2 }}</th>
                        <th class="text-end">R {{ totals.days_90|default:0|floatformat:2 }}</th>
                        <th class="text-end">R {{ totals.days_120|default:0|floatformat:2 }}</th>
                        <th class="text-end">R {{ totals.days_150|default:0|floatformat:2 }}</th>
                        <th class="text-end">R {{ totals.days_180|default:0|floatformat:2 }}</th>
                        <th class="text-end"><strong>R {{ totals.total|default:0|floatformat:2 }}</strong></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Age Analysis Chart -->
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar"></i> Visual Analysis
            </div>
            <div class="card-body">
                <canvas id="ageChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie"></i> Distribution
            </div>
            <div class="card-body">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Bar Chart
const ctxBar = document.getElementById('ageChart').getContext('2d');
const ageChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
        labels: ['Current', '30 Days', '60 Days', '90 Days', '120 Days', '150 Days', '180+ Days'],
        datasets: [{
            label: 'Outstanding Amount (R)',
            data: [
                {{ totals.current|default:0 }},
                {{ totals.days_30|default:0 }},
                {{ totals.days_60|default:0 }},
                {{ totals.days_90|default:0 }},
                {{ totals.days_120|default:0 }},
                {{ totals.days_150|default:0 }},
                {{ totals.days_180|default:0 }}
            ],
            backgroundColor: [
                'rgba(75, 192, 192, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(201, 203, 207, 0.6)'
            ]
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R ' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

// Pie Chart
const ctxPie = document.getElementById('pieChart').getContext('2d');
const pieChart = new Chart(ctxPie, {
    type: 'pie',
    data: {
        labels: ['Current', '30 Days', '60 Days', '90 Days', '120+'],
        datasets: [{
            data: [
                {{ totals.current|default:0 }},
                {{ totals.days_30|default:0 }},
                {{ totals.days_60|default:0 }},
                {{ totals.days_90|default:0 }},
                {{ totals.days_120|default:0 }} + {{ totals.days_150|default:0 }} + {{ totals.days_180|default:0 }}
            ],
            backgroundColor: [
                'rgba(75, 192, 192, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(255, 99, 132, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Export to Excel
function exportToExcel() {
    const table = document.getElementById('ageAnalysisTable');
    const wb = XLSX.utils.table_to_book(table, {sheet: "Age Analysis"});
    XLSX.writeFile(wb, 'age_analysis_' + new Date().toISOString().split('T')[0] + '.xlsx');
}
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Batch Receipt Posting - Debtors System{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'debtors:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item">Transactions</li>
        <li class="breadcrumb-item active">Batch Receipt Posting</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-receipt"></i> Batch Receipt Posting</h1>
    <p class="text-muted">Record payments received from debtors</p>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-money-bill-wave"></i> Receipt Entry
            </div>
            <div class="card-body">
                <form method="post" id="receiptForm">
                    {% csrf_token %}
                    
                    <!-- Account Selection -->
                    <div class="mb-3">
                        <label class="form-label">Debtor Account <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="account_number" 
                                   placeholder="Account number" required>
                            <button class="btn btn-outline-secondary" type="button" id="searchAccount">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div id="accountInfo" style="display:none;">
                        <div class="alert alert-info">
                            <h6 id="accountName"></h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Balance:</strong> <span id="accountBalance"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Category:</strong> <span id="accountCategory"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Receipt Details -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" name="date" 
                                       value="{% now 'Y-m-d' %}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Receipt Number</label>
                                <input type="text" class="form-control" name="receipt_number" 
                                       value="{{ next_receipt_number }}" readonly>
                            </div>
                        </div>

                        <!-- Balance Forward Section -->
                        <div id="balanceForwardSection" style="display:none;">
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Amount Due <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="amount_due" 
                                           step="0.01" min="0" id="amountDue">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Amount Tendered <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="amount_tendered" 
                                           step="0.01" min="0" id="amountTendered">
                                    <small class="text-muted">May be less if settlement discount taken</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Settlement Discount</label>
                                    <input type="number" class="form-control" id="settlementDiscount" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-control" id="discountPercent" readonly>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Reference</label>
                                    <input type="text" class="form-control" name="reference" 
                                           placeholder="Payment reference">
                                </div>
                            </div>

                            <!-- Ageing Allocation -->
                            <div class="mt-4">
                                <h6>Allocate Ageing <span class="text-danger">*</span></h6>
                                <small class="text-muted">Total must equal Amount Due</small>
                                <div class="row g-2 mt-2">
                                    <div class="col-md-4">
                                        <label class="small">Current</label>
                                        <input type="number" class="form-control form-control-sm ageing-input" 
                                               name="current" step="0.01" min="0" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small">30 Days</label>
                                        <input type="number" class="form-control form-control-sm ageing-input" 
                                               name="days_30" step="0.01" min="0" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small">60 Days</label>
                                        <input type="number" class="form-control form-control-sm ageing-input" 
                                               name="days_60" step="0.01" min="0" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small">90 Days</label>
                                        <input type="number" class="form-control form-control-sm ageing-input" 
                                               name="days_90" step="0.01" min="0" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small">120 Days</label>
                                        <input type="number" class="form-control form-control-sm ageing-input" 
                                               name="days_120" step="0.01" min="0" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small">150+ Days</label>
                                        <input type="number" class="form-control form-control-sm ageing-input" 
                                               name="days_150" step="0.01" min="0" value="0">
                                    </div>
                                </div>
                                <div class="alert alert-secondary mt-2">
                                    <strong>Total:</strong> R <span id="ageingTotal">0.00</span>
                                    <span id="ageingStatus" class="float-end"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Open Item Section -->
                        <div id="openItemSection" style="display:none;">
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Amount Paid <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="amount_paid" 
                                           step="0.01" min="0" id="amountPaid">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Reference</label>
                                    <input type="text" class="form-control" name="reference" 
                                           placeholder="Payment reference">
                                </div>
                            </div>

                            <!-- Open Items Table -->
                            <div class="mt-4">
                                <h6>Allocate Payment to Transactions</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm" id="openItemsTable">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Number</th>
                                                <th>Date</th>
                                                <th class="text-end">Balance</th>
                                                <th class="text-end">Amount Paid</th>
                                                <th class="text-end">Discount</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="openItemsList">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Post Receipt
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Batch Summary -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="fas fa-list-ul"></i> Batch Summary
            </div>
            <div class="card-body">
                <h5>Total: R <span id="batchTotal">0.00</span></h5>
                <small class="text-muted">{{ batch_count }} receipts</small>
                
                <div class="list-group mt-3" id="batchList">
                    {% for receipt in batch_receipts %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <strong>{{ receipt.account }}</strong>
                            <span>R {{ receipt.amount|floatformat:2 }}</span>
                        </div>
                        <small>{{ receipt.reference }}</small>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">No receipts in batch</p>
                    {% endfor %}
                </div>

                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-success" onclick="endBatch()">
                        <i class="fas fa-check-circle"></i> End Batch
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let accountCategory = '';

$(document).ready(function() {
    $('#searchAccount').click(searchAccount);
    $('#account_number').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchAccount();
        }
    });

    // Calculate settlement discount
    $('#amountTendered').on('input', function() {
        const due = parseFloat($('#amountDue').val()) || 0;
        const tendered = parseFloat($(this).val()) || 0;
        const discount = due - tendered;
        const percent = due > 0 ? (discount / due * 100) : 0;
        
        $('#settlementDiscount').val(discount.toFixed(2));
        $('#discountPercent').val(percent.toFixed(2));
    });

    $('.ageing-input').on('input', calculateAgeingTotal);
});

function searchAccount() {
    const accountNumber = $('#account_number').val();
    $.ajax({
        url: '{% url "debtors:get_account_details" %}',
        data: { account_number: accountNumber },
        success: function(data) {
            if (data.success) {
                accountCategory = data.category;
                $('#accountName').text(data.name);
                $('#accountBalance').text('R ' + data.balance);
                $('#accountCategory').text(data.category_display);
                $('#accountInfo').show();

                if (data.category === 'O') {
                    $('#openItemSection').show();
                    $('#balanceForwardSection').hide();
                    loadOpenItems(accountNumber);
                } else {
                    $('#balanceForwardSection').show();
                    $('#openItemSection').hide();
                }
            } else {
                alert('Account not found');
            }
        }
    });
}

function loadOpenItems(accountNumber) {
    $.ajax({
        url: '{% url "debtors:get_open_items" %}',
        data: { account_number: accountNumber },
        success: function(data) {
            let html = '';
            data.items.forEach(item => {
                html += `
                    <tr>
                        <td>${item.type}</td>
                        <td>${item.number}</td>
                        <td>${item.date}</td>
                        <td class="text-end">R ${item.balance}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm" 
                                   step="0.01" min="0" max="${item.balance}" 
                                   data-item-id="${item.id}">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm" 
                                   step="0.01" min="0">
                        </td>
                        <td><span class="badge bg-secondary">Pending</span></td>
                    </tr>
                `;
            });
            $('#openItemsList').html(html);
        }
    });
}

function calculateAgeingTotal() {
    let total = 0;
    $('.ageing-input').each(function() {
        total += parseFloat($(this).val()) || 0;
    });
    
    $('#ageingTotal').text(total.toFixed(2));
    
    const due = parseFloat($('#amountDue').val()) || 0;
    if (Math.abs(total - due) < 0.01) {
        $('#ageingStatus').html('<span class="badge bg-success">Balanced</span>');
    } else {
        $('#ageingStatus').html('<span class="badge bg-danger">Not Balanced</span>');
    }
}

function resetForm() {
    $('#receiptForm')[0].reset();
    $('#accountInfo').hide();
}

function endBatch() {
    if (confirm('End this batch?')) {
        window.location.href = '{% url "debtors:end_receipt_batch" %}';
    }
}
</script>
{% endblock %}
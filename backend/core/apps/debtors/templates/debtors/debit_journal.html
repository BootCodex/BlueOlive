{% extends 'base.html' %}

{% block title %}Debit Journal - Debtors System{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'debtors:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item">Transactions</li>
        <li class="breadcrumb-item active">Debit Journal</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-plus-circle"></i> Debit Journal</h1>
    <p class="text-muted">Increases the balance owing by the Debtor</p>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Journal Entry Form -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-edit"></i> Journal Entry
            </div>
            <div class="card-body">
                <form method="post" id="debitJournalForm">
                    {% csrf_token %}
                    
                    <!-- Account Selection -->
                    <div class="mb-3">
                        <label class="form-label">Debtor Account <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="account_number" name="account_number" 
                                   placeholder="Account number" required>
                            <button class="btn btn-outline-secondary" type="button" id="searchAccount">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>

                    <!-- Account Details Display -->
                    <div id="accountDetails" style="display: none;">
                        <div class="alert alert-info">
                            <h6 id="accountName"></h6>
                            <p class="mb-0">
                                <strong>Current Balance:</strong> <span id="accountBalance"></span><br>
                                <strong>Credit Limit:</strong> <span id="accountCredit"></span>
                            </p>
                        </div>

                        <!-- Journal Details -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" name="date" 
                                       value="{% now 'Y-m-d' %}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Journal Number</label>
                                <input type="text" class="form-control" name="journal_number" 
                                       value="{{ next_journal_number }}" readonly>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Journal Amount <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="amount" 
                                       step="0.01" min="0" id="journalAmount" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Additional Reference</label>
                                <textarea class="form-control" name="reference" rows="2" 
                                          placeholder="Explanation for this journal entry"></textarea>
                                <small class="form-text text-muted">
                                    Appears on Statement, Journal Report, and GL Integration
                                </small>
                            </div>
                        </div>

                        <!-- Ageing Allocation -->
                        <div class="mt-4" id="ageingSection">
                            <h6>Allocate Ageing <span class="text-danger">*</span></h6>
                            <small class="text-muted">Total must equal Journal Amount</small>
                            
                            <div class="row g-2 mt-2" id="ageingAllocation">
                                <!-- For Balance Brought Forward -->
                                <div class="col-md-4">
                                    <label class="form-label small">Current</label>
                                    <input type="number" class="form-control form-control-sm ageing-input" 
                                           name="current" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">30 Days</label>
                                    <input type="number" class="form-control form-control-sm ageing-input" 
                                           name="days_30" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">60 Days</label>
                                    <input type="number" class="form-control form-control-sm ageing-input" 
                                           name="days_60" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">90 Days</label>
                                    <input type="number" class="form-control form-control-sm ageing-input" 
                                           name="days_90" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">120 Days</label>
                                    <input type="number" class="form-control form-control-sm ageing-input" 
                                           name="days_120" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">150 Days</label>
                                    <input type="number" class="form-control form-control-sm ageing-input" 
                                           name="days_150" step="0.01" min="0" value="0">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label small">180+ Days</label>
                                    <input type="number" class="form-control form-control-sm ageing-input" 
                                           name="days_180" step="0.01" min="0" value="0">
                                </div>
                            </div>

                            <div class="mt-3">
                                <div class="alert alert-secondary">
                                    <strong>Ageing Total:</strong> R <span id="ageingTotal">0.00</span>
                                    <span id="ageingStatus" class="float-end"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Open Item Ageing (Alternative) -->
                        <div class="mt-4" id="openItemSection" style="display: none;">
                            <h6>Select Ageing Period <span class="text-danger">*</span></h6>
                            <small class="text-muted">Journal amount allocated to ONE period</small>
                            <select class="form-select mt-2" name="open_item_period">
                                <option value="current">Current</option>
                                <option value="30">30 Days</option>
                                <option value="60">60 Days</option>
                                <option value="90">90 Days</option>
                                <option value="120">120 Days</option>
                                <option value="150">150 Days</option>
                                <option value="180">180+ Days</option>
                            </select>
                        </div>

                        <!-- Buttons -->
                        <div class="mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                            <button type="submit" class="btn btn-primary" id="updateBtn" disabled>
                                <i class="fas fa-check"></i> Update Journal
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Batch Summary -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="fas fa-list"></i> Current Batch
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h5>Batch Total: <span id="batchTotal">R 0.00</span></h5>
                    <small class="text-muted">{{ batch_entries|length }} entries</small>
                </div>

                <div class="list-group" id="batchList">
                    {% for entry in batch_entries %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <strong>{{ entry.account_name }}</strong>
                            <span>R {{ entry.amount|floatformat:2 }}</span>
                        </div>
                        <small class="text-muted">{{ entry.reference }}</small>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">No entries yet</p>
                    {% endfor %}
                </div>

                <div class="d-grid gap-2 mt-3">
                    <button type="button" class="btn btn-success" id="endBatch" 
                            {% if not batch_entries %}disabled{% endif %}>
                        <i class="fas fa-check-circle"></i> End Batch
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Tips -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-lightbulb"></i> Quick Tips
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li>Debit journals increase debtor balances</li>
                    <li>Total ageing must equal journal amount</li>
                    <li>Open Item: allocate to ONE period only</li>
                    <li>Journal numbers are auto-sequential</li>
                    <li>End batch when all entries complete</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let accountCategory = '';

$(document).ready(function() {
    // Search account
    $('#searchAccount').on('click', function() {
        searchDebtorAccount();
    });

    $('#account_number').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchDebtorAccount();
        }
    });

    // Calculate ageing total
    $('.ageing-input').on('input', function() {
        calculateAgeingTotal();
    });

    // Auto-fill current when amount entered
    $('#journalAmount').on('input', function() {
        const amount = parseFloat($(this).val()) || 0;
        if (accountCategory === 'B') { // Balance Forward
            $('input[name="current"]').val(amount.toFixed(2));
            calculateAgeingTotal();
        }
    });

    // End batch
    $('#endBatch').on('click', function() {
        if (confirm('Are you sure you want to end this batch?')) {
            window.location.href = '{% url "debtors:end_journal_batch" %}';
        }
    });
});

function searchDebtorAccount() {
    const accountNumber = $('#account_number').val();
    if (!accountNumber) {
        alert('Please enter an account number');
        return;
    }

    $.ajax({
        url: '{% url "debtors:get_account_details" %}',
        data: { account_number: accountNumber },
        success: function(data) {
            if (data.success) {
                accountCategory = data.category;
                $('#accountName').text(data.name);
                $('#accountBalance').text('R ' + data.balance);
                $('#accountCredit').text('R ' + data.credit_limit);
                $('#accountDetails').show();

                // Show appropriate ageing section
                if (data.category === 'O') {
                    $('#ageingAllocation').hide();
                    $('#openItemSection').show();
                } else {
                    $('#ageingAllocation').show();
                    $('#openItemSection').hide();
                }
            } else {
                alert(data.message || 'Account not found');
            }
        },
        error: function() {
            alert('Error searching for account');
        }
    });
}

function calculateAgeingTotal() {
    let total = 0;
    $('.ageing-input').each(function() {
        total += parseFloat($(this).val()) || 0;
    });
    
    $('#ageingTotal').text(total.toFixed(2));
    
    const journalAmount = parseFloat($('#journalAmount').val()) || 0;
    if (Math.abs(total - journalAmount) < 0.01) {
        $('#ageingStatus').html('<span class="badge bg-success">Balanced</span>');
        $('#updateBtn').prop('disabled', false);
    } else {
        $('#ageingStatus').html('<span class="badge bg-danger">Not Balanced</span>');
        $('#updateBtn').prop('disabled', true);
    }
}

function resetForm() {
    $('#debitJournalForm')[0].reset();
    $('#accountDetails').hide();
    $('#ageingTotal').text('0.00');
    $('#ageingStatus').html('');
}
</script>
{% endblock %}
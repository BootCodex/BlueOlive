<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        nav { background: #f0f0f0; padding: 10px; margin-bottom: 20px; }
        nav ul { list-style: none; padding: 0; }
        nav li { display: inline; margin-right: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        button { margin: 5px; padding: 8px 12px; cursor: pointer; }
        .form { margin-top: 20px; padding: 20px; background: #f9f9f9; border: 1px solid #ddd; }
        input, textarea, select { margin: 5px; padding: 8px; width: 100%; max-width: 400px; box-sizing: border-box; }
        .hidden { display: none; }
        .shop-url { color: #0066cc; font-size: 0.9em; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .readonly-hint { font-size: 0.85em; color: #666; font-style: italic; }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><strong>Tenant: <span id="tenant"></span> | User: <span id="user"></span></strong></li>
            <li><a href="#shops">Shop Management</a></li>
            <li><a href="#users">User Management</a></li>
            <li><a href="#cashbook">Cash Book</a></li>
            <li><a href="#creditors">Creditors</a></li>
            <li><a href="#stock">Stock Control</a></li>
            <li><button id="logout">Logout</button></li>
        </ul>
    </nav>

    <h2 id="shops">Shop Management</h2>
    <button id="addShopBtn">Add Shop</button>
    <table id="shopsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Schema</th>
                <th>Subdomain</th>
                <th>Shop URL</th>
                <th>Head Office</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="shopForm" class="form hidden">
        <h3 id="shopFormTitle">Add Shop</h3>
        <input type="hidden" id="shopId">
        
        <div class="form-group" id="shopTenantGroup">
            <label for="shopTenant">Tenant:</label>
            <select id="shopTenant">
                <!-- Tenants will be loaded dynamically -->
            </select>
        </div>
        
        <div class="form-group">
            <label for="shopName">Shop Name: *</label>
            <input type="text" id="shopName" placeholder="e.g., Downtown Store" required>
        </div>
        
        <div class="form-group">
            <label for="shopDescription">Description:</label>
            <textarea id="shopDescription" placeholder="Optional description" rows="3"></textarea>
        </div>
        
        <div class="form-group">
            <label for="shopSubdomain">Subdomain: *</label>
            <input type="text" id="shopSubdomain" placeholder="e.g., downtown">
            <div class="shop-url" id="shopUrlPreview"></div>
        </div>
        
        <div class="form-group">
            <label for="schemaName">Schema Name:</label>
            <input type="text" id="schemaName" placeholder="Auto-generated" readonly>
            <span class="readonly-hint">(Auto-generated based on tenant and shop name)</span>
        </div>
        
        <div class="form-group">
            <label><input type="checkbox" id="isHeadOffice"> Head Office</label>
        </div>
        
        <button id="saveShop">Save</button>
        <button id="cancelShop">Cancel</button>
    </div>

    <h2 id="users">User Management</h2>
    <button id="addUserBtn">Add User</button>
    <table id="usersTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Shop</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="userForm" class="form hidden">
        <h3 id="formTitle">Add User</h3>
        <input type="hidden" id="userId">
        
        <div class="form-group" id="userTenantGroup">
            <label for="tenant">Tenant:</label>
            <select id="tenant">
                <!-- Tenants will be loaded dynamically -->
            </select>
        </div>
        
        <div class="form-group">
            <label for="username">Username: *</label>
            <input type="text" id="username" placeholder="Username" required>
        </div>
        
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="Email">
        </div>
        
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" placeholder="First Name">
        </div>
        
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" placeholder="Last Name">
        </div>
        
        <div class="form-group">
            <label for="phone">Phone Number:</label>
            <input type="tel" id="phone" placeholder="Phone Number">
        </div>
        
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Password">
        </div>
        
        <div class="form-group">
            <label for="passwordConfirm">Confirm Password:</label>
            <input type="password" id="passwordConfirm" placeholder="Confirm Password">
        </div>
        
        <div class="form-group">
            <label for="role">Role: *</label>
            <select id="role" required>
                <option value="CUSTOMER">Customer</option>
                <option value="STAFF">Staff</option>
                <option value="MANAGER">Manager</option>
                <option value="ADMIN">Admin</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="shop">Shop:</label>
            <select id="shop">
                <option value="">No Shop</option>
                <!-- Shops will be loaded dynamically -->
            </select>
        </div>
        
        <button id="saveUser">Save</button>
        <button id="cancelUser">Cancel</button>
    </div>

    <script>
        const apiBase = window.location.origin;

        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        }

        function generateShopUrl(subdomain, tenantSlug) {
            if (!subdomain || !tenantSlug) return '';
            const hostname = window.location.hostname;
            const port = window.location.port ? `:${window.location.port}` : '';
            const protocol = window.location.protocol;
            
            // Handle localhost
            if (hostname.includes('localhost')) {
                return `${protocol}//${subdomain}.${tenantSlug}.localhost${port}`;
            }
            
            // Handle regular domains (e.g., example.com)
            const domainParts = hostname.split('.');
            const baseDomain = domainParts.slice(-2).join('.');
            return `${protocol}//${subdomain}.${tenantSlug}.${baseDomain}${port}`;
        }

        async function loadTenant() {
            try {
                const response = await fetch(`${apiBase}/api/current_tenant/`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('tenant').textContent = data.name || 'None';
                    window.tenantSlug = data.slug;
                    window.tenantId = data.id;
                    window.tenantName = data.name;
                    localStorage.setItem('tenantSlug', data.slug || '');
                } else {
                    const fallback = window.location.hostname.split('.')[0];
                    document.getElementById('tenant').textContent = fallback;
                    window.tenantSlug = fallback;
                    localStorage.setItem('tenantSlug', fallback);
                }
            } catch (error) {
                const fallback = window.location.hostname.split('.')[0];
                document.getElementById('tenant').textContent = fallback;
                window.tenantSlug = fallback;
                localStorage.setItem('tenantSlug', fallback);
            }
        }

        async function loadUser() {
            try {
                const response = await fetch(`${apiBase}/api/current_user/`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('user').textContent = data.username || 'Guest';
                    window.userRole = data.role;
                    window.isSuperuser = data.is_superuser;
                    setRoleBasedVisibility();
                    loadTenants();
                } else {
                    document.getElementById('user').textContent = 'Guest';
                    window.userRole = null;
                    window.isSuperuser = false;
                    setRoleBasedVisibility();
                    loadTenants();
                }
            } catch (error) {
                document.getElementById('user').textContent = 'Guest';
                window.userRole = null;
                window.isSuperuser = false;
                setRoleBasedVisibility();
                loadTenants();
            }
        }

        async function loadTenants() {
            if (window.isSuperuser) {
                try {
                    const response = await fetch(`${apiBase}/api/tenants/`, { credentials: 'include' });
                    if (response.ok) {
                        const tenants = await response.json();
                        window.tenants = tenants;
                        populateTenantSelect(tenants);
                    }
                } catch (error) {
                    console.error('Error loading tenants:', error);
                }
            }
        }

        function populateTenantSelect(tenants) {
            const userTenantSelect = document.getElementById('tenant');
            const shopTenantSelect = document.getElementById('shopTenant');
            userTenantSelect.innerHTML = '';
            shopTenantSelect.innerHTML = '';
            tenants.forEach(tenant => {
                const option1 = document.createElement('option');
                option1.value = tenant.id;
                option1.textContent = tenant.name;
                option1.dataset.slug = tenant.slug;
                userTenantSelect.appendChild(option1);
                const option2 = option1.cloneNode(true);
                option2.dataset.slug = tenant.slug;
                shopTenantSelect.appendChild(option2);
            });
            // Set default to current tenant
            if (window.tenantId) {
                userTenantSelect.value = window.tenantId;
                shopTenantSelect.value = window.tenantId;
            }
        }

        async function loadShops(tenantSlug = null) {
            try {
                let url = `${apiBase}/api/tenant_shops/`;
                if (tenantSlug) {
                    url += `?tenant=${tenantSlug}`;
                }
                const response = await fetch(url, {
                    credentials: 'include',
                    headers: getHeaders()
                });
                if (response.ok) {
                    const shops = await response.json();
                    const shopSelect = document.getElementById('shop');
                    shopSelect.innerHTML = '<option value="">No Shop</option>';
                    shops.forEach(shop => {
                        const option = document.createElement('option');
                        option.value = shop.id;
                        option.textContent = shop.name;
                        shopSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading shops:', error);
            }
        }

        function setRoleBasedVisibility() {
            const role = window.userRole;
            const isSuper = window.isSuperuser;

            // Define permissions
            const canManageUsers = isSuper || role === 'ADMIN';
            const canViewCashBook = isSuper || ['ADMIN', 'MANAGER', 'STAFF'].includes(role);
            const canViewCreditors = isSuper || ['ADMIN', 'MANAGER', 'STAFF'].includes(role);
            const canViewStock = isSuper || ['ADMIN', 'MANAGER', 'STAFF'].includes(role);

            // Show/hide navigation links
            document.querySelector('a[href="#shops"]').style.display = canManageUsers ? 'inline' : 'none';
            document.querySelector('a[href="#users"]').style.display = canManageUsers ? 'inline' : 'none';
            document.querySelector('a[href="#cashbook"]').style.display = canViewCashBook ? 'inline' : 'none';
            document.querySelector('a[href="#creditors"]').style.display = canViewCreditors ? 'inline' : 'none';
            document.querySelector('a[href="#stock"]').style.display = canViewStock ? 'inline' : 'none';

            // Show/hide sections
            document.getElementById('shops').style.display = canManageUsers ? 'block' : 'none';
            document.getElementById('users').style.display = canManageUsers ? 'block' : 'none';
            
            // Show/hide tenant selects
            const userTenantGroup = document.getElementById('userTenantGroup');
            const shopTenantGroup = document.getElementById('shopTenantGroup');
            
            if (isSuper) {
                userTenantGroup.style.display = 'block';
                shopTenantGroup.style.display = 'block';
            } else if (role === 'ADMIN') {
                userTenantGroup.style.display = 'none';
                shopTenantGroup.style.display = 'block';
                document.getElementById('shopTenant').disabled = true;
            } else {
                userTenantGroup.style.display = 'none';
                shopTenantGroup.style.display = 'none';
            }
        }

        function getCsrfToken() {
            const name = 'csrftoken';
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function getHeaders(includeCsrf = false) {
            const headers = {
                'X-Tenant': localStorage.getItem('tenantSlug') || '',
            };
            if (includeCsrf) {
                const csrf = getCsrfToken();
                if (csrf) headers['X-CSRFToken'] = csrf;
            }
            return headers;
        }

        async function fetchShops() {
            try {
                const response = await fetch(`${apiBase}/api/shops/`, {
                    credentials: 'include',
                    headers: getHeaders()
                });
                if (response.ok) {
                    const shops = await response.json();
                    displayShops(shops);
                } else if (response.status === 403) {
                    alert('Unauthorized. Please login.');
                    window.location.href = '/login/';
                } else {
                    alert('Error fetching shops');
                }
            } catch (error) {
                console.error('Error fetching shops:', error);
                alert('Network error fetching shops');
            }
        }

        function displayShops(shops) {
            const tbody = document.querySelector('#shopsTable tbody');
            tbody.innerHTML = '';
            shops.forEach(shop => {
                const row = document.createElement('tr');
                const shopUrl = shop.subdomain ? generateShopUrl(shop.subdomain, window.tenantSlug) : 'N/A';
                row.innerHTML = `
                    <td>${shop.id}</td>
                    <td>${shop.name}</td>
                    <td>${shop.description || ''}</td>
                    <td><code>${shop.schema_name}</code></td>
                    <td><strong>${shop.subdomain || 'N/A'}</strong></td>
                    <td><span class="shop-url">${shopUrl !== 'N/A' ? `<a href="${shopUrl}" target="_blank">${shopUrl}</a>` : 'N/A'}</span></td>
                    <td>${shop.is_head_office ? 'âœ“ Yes' : 'No'}</td>
                    <td>
                        <button onclick="editShop(${shop.id})">Edit</button>
                        <button onclick="deleteShop(${shop.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function fetchUsers() {
            try {
                const response = await fetch(`${apiBase}/api/users/`, {
                    credentials: 'include',
                    headers: getHeaders()
                });
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                } else if (response.status === 403) {
                    alert('Unauthorized. Please login.');
                    window.location.href = '/login/';
                } else {
                    alert('Error fetching users');
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                alert('Network error fetching users');
            }
        }

        function displayUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email || ''}</td>
                    <td>${user.first_name || ''}</td>
                    <td>${user.last_name || ''}</td>
                    <td>${user.phone || ''}</td>
                    <td>${user.role || ''}</td>
                    <td>${user.shop_name || ''}</td>
                    <td>
                        <button onclick="editUser(${user.id})">Edit</button>
                        <button onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        document.getElementById('addShopBtn').addEventListener('click', () => {
            showShopForm();
        });

        document.getElementById('cancelShop').addEventListener('click', () => {
            hideShopForm();
        });

        document.getElementById('saveShop').addEventListener('click', async () => {
            const id = document.getElementById('shopId').value;
            const name = document.getElementById('shopName').value;
            const subdomain = document.getElementById('shopSubdomain').value;

            // Validation
            if (!name) {
                alert('Shop name is required');
                return;
            }
            if (!subdomain) {
                alert('Subdomain is required');
                return;
            }

            const data = {
                name,
                description: document.getElementById('shopDescription').value,
                subdomain: subdomain,
                is_head_office: document.getElementById('isHeadOffice').checked,
            };
            
            if (window.isSuperuser || window.userRole === 'ADMIN') {
                data.tenant = document.getElementById('shopTenant').value;
            }
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${apiBase}/api/shops/${id}/` : `${apiBase}/api/shops/`;

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getHeaders(true)
                    },
                    body: JSON.stringify(data),
                    credentials: 'include',
                });
                if (response.ok) {
                    fetchShops();
                    hideShopForm();
                } else {
                    const errorData = await response.json();
                    const errorMsg = errorData.detail || Object.values(errorData).flat().join(', ') || 'Error saving shop';
                    alert('Error saving shop: ' + errorMsg);
                }
            } catch (error) {
                console.error('Error saving shop:', error);
                alert('Network error saving shop');
            }
        });

        function editShop(id) {
            fetch(`${apiBase}/api/shops/${id}/`, {
                credentials: 'include',
                headers: getHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch shop');
                    }
                    return response.json();
                })
                .then(shop => {
                    document.getElementById('shopId').value = shop.id;
                    document.getElementById('shopName').value = shop.name;
                    document.getElementById('shopDescription').value = shop.description || '';
                    document.getElementById('schemaName').value = shop.schema_name;
                    document.getElementById('shopSubdomain').value = shop.subdomain || '';
                    document.getElementById('isHeadOffice').checked = shop.is_head_office;
                    document.getElementById('shopFormTitle').textContent = 'Edit Shop';
                    updateShopUrlPreview();
                    showShopForm();
                })
                .catch(error => {
                    console.error('Error fetching shop:', error);
                    alert('Error fetching shop details');
                });
        }

        async function deleteShop(id) {
            if (confirm('Are you sure you want to delete this shop?')) {
                try {
                    const response = await fetch(`${apiBase}/api/shops/${id}/`, {
                        method: 'DELETE',
                        headers: getHeaders(true),
                        credentials: 'include',
                    });
                    if (response.ok) {
                        fetchShops();
                    } else {
                        alert('Error deleting shop');
                    }
                } catch (error) {
                    console.error('Error deleting shop:', error);
                    alert('Network error deleting shop');
                }
            }
        }

        function showShopForm() {
            document.getElementById('shopForm').classList.remove('hidden');
            updateShopUrlPreview();
        }

        function hideShopForm() {
            document.getElementById('shopForm').classList.add('hidden');
            document.getElementById('shopId').value = '';
            document.getElementById('shopName').value = '';
            document.getElementById('shopDescription').value = '';
            document.getElementById('schemaName').value = '';
            document.getElementById('shopSubdomain').value = '';
            document.getElementById('isHeadOffice').checked = false;
            document.getElementById('shopFormTitle').textContent = 'Add Shop';
            document.getElementById('shopUrlPreview').textContent = '';
        }

        function updateShopUrlPreview() {
            const subdomain = document.getElementById('shopSubdomain').value;
            const tenantSlug = window.tenantSlug;
            if (subdomain && tenantSlug) {
                const shopUrl = generateShopUrl(subdomain, tenantSlug);
                document.getElementById('shopUrlPreview').textContent = `Shop URL: ${shopUrl}`;
            } else {
                document.getElementById('shopUrlPreview').textContent = '';
            }
        }

        document.getElementById('addUserBtn').addEventListener('click', () => {
            showForm();
        });

        document.getElementById('cancelUser').addEventListener('click', () => {
            hideForm();
        });

        document.getElementById('saveUser').addEventListener('click', async () => {
            const id = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            const username = document.getElementById('username').value;
            const role = document.getElementById('role').value;

            // Validation
            if (!username) {
                alert('Username is required');
                return;
            }
            if (!role) {
                alert('Role is required');
                return;
            }
            if (!id && !password) {
                alert('Password is required for new users');
                return;
            }
            if (password !== passwordConfirm) {
                alert('Passwords do not match');
                return;
            }
            if (password && password.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }

            const data = {
                username,
                email: document.getElementById('email').value,
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                role,
                shop: document.getElementById('shop').value || null,
            };
            if (password) {
                data.password = password;
            }
            if (window.isSuperuser) {
                data.tenant = document.getElementById('tenant').value;
            }
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${apiBase}/api/users/${id}/` : `${apiBase}/api/users/`;

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getHeaders(true)
                    },
                    body: JSON.stringify(data),
                    credentials: 'include',
                });
                if (response.ok) {
                    fetchUsers();
                    hideForm();
                } else {
                    const errorData = await response.json();
                    const errorMsg = errorData.detail || Object.values(errorData).flat().join(', ') || 'Error saving user';
                    alert('Error saving user: ' + errorMsg);
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Network error saving user');
            }
        });

        function editUser(id) {
            fetch(`${apiBase}/api/users/${id}/`, {
                credentials: 'include',
                headers: getHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch user');
                    }
                    return response.json();
                })
                .then(user => {
                    document.getElementById('userId').value = user.id;
                    document.getElementById('username').value = user.username;
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('firstName').value = user.first_name || '';
                    document.getElementById('lastName').value = user.last_name || '';
                    document.getElementById('phone').value = user.phone || '';
                    document.getElementById('role').value = user.role || 'CUSTOMER';
                    document.getElementById('shop').value = user.shop || '';
                    document.getElementById('password').value = '';
                    document.getElementById('passwordConfirm').value = '';
                    document.getElementById('formTitle').textContent = 'Edit User';
                    showForm();
                })
                .catch(error => {
                    console.error('Error fetching user:', error);
                    alert('Error fetching user details');
                });
        }

        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`${apiBase}/api/users/${id}/`, {
                        method: 'DELETE',
                        headers: getHeaders(true),
                        credentials: 'include',
                    });
                    if (response.ok) {
                        fetchUsers();
                    } else {
                        alert('Error deleting user');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Network error deleting user');
                }
            }
        }

        function showForm() {
            document.getElementById('userForm').classList.remove('hidden');
        }

        function hideForm() {
            document.getElementById('userForm').classList.add('hidden');
            document.getElementById('userId').value = '';
            document.getElementById('username').value = '';
            document.getElementById('email').value = '';
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('role').value = 'CUSTOMER';
            document.getElementById('shop').value = '';
            document.getElementById('password').value = '';
            document.getElementById('passwordConfirm').value = '';
            document.getElementById('formTitle').textContent = 'Add User';
        }

        // Auto-generate subdomain and schema name from shop name
        document.getElementById('shopName').addEventListener('input', () => {
            const name = document.getElementById('shopName').value;
            const slug = slugify(name);
            const tenantSlug = window.tenantSlug || '';
            
            // Set subdomain (just the shop part)
            document.getElementById('shopSubdomain').value = slug;
            
            // Set schema name (tenant_shop format)
            if (tenantSlug) {
                document.getElementById('schemaName').value = `${tenantSlug}_${slug}`;
            } else {
                document.getElementById('schemaName').value = slug;
            }
            
            updateShopUrlPreview();
        });

        // Update URL preview when subdomain changes
        document.getElementById('shopSubdomain').addEventListener('input', () => {
            const subdomain = document.getElementById('shopSubdomain').value;
            const tenantSlug = window.tenantSlug || '';
            
            // Update schema name when subdomain is manually edited
            if (tenantSlug) {
                document.getElementById('schemaName').value = `${tenantSlug}_${subdomain}`;
            }
            
            updateShopUrlPreview();
        });

        document.getElementById('logout').addEventListener('click', async () => {
            try {
                await fetch(`${apiBase}/api/logout/`, {
                    method: 'POST',
                    headers: getHeaders(true),
                    credentials: 'include',
                });
                window.location.href = '/login/';
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Error logging out');
            }
        });

        // Load tenant, user, shops and users on page load
        (async () => {
            await loadTenant();
            await loadUser();
            loadShops();
            fetchShops();
            fetchUsers();
        })();

        // Reload shops when tenant changes for superusers
        document.getElementById('tenant').addEventListener('change', () => {
            const selectedTenantId = document.getElementById('tenant').value;
            if (selectedTenantId && window.tenants) {
                const tenant = window.tenants.find(t => t.id == selectedTenantId);
                const tenantSlug = tenant ? tenant.slug : null;
                loadShops(tenantSlug);
            } else {
                loadShops();
            }
        });

        // Update tenant context when shop tenant selector changes
        document.getElementById('shopTenant').addEventListener('change', () => {
            const selectedOption = document.getElementById('shopTenant').selectedOptions[0];
            if (selectedOption && selectedOption.dataset.slug) {
                window.tenantSlug = selectedOption.dataset.slug;
                updateShopUrlPreview();
            }
        });
    </script>
</body>
</html>